---
sidebar: sidebar 
permalink: task_config_telegraf_agent_k8s.html 
keywords: telegraf, installation, install, agent, telegraf agent, kubernetes, eks, operator, k8s 
summary: Cloud Insights は、 Kubernetes で統合データを収集するエージェントとして Telegraf をサポートしています。 
---
= NetApp Kubernetes Monitoring Operatorの設定
:toc: macro
:hardbreaks:
:toclevels: 2
:allow-uri-read: 
:toc: 
:nofooter: 
:toclevels: 2
:icons: font
:linkattrs: 
:imagesdir: ./media/
:toc-position: content


[role="lead"]
Cloud Insights では、Kubernetesコレクション向けにNetApp Kubernetes Monitoring Operator *（NKMO）を提供しています。データコレクタを追加するときは、「Kubernetes」タイルを選択するだけです。


toc::[]
演算子(NKMO)とデータコレクタは、Cloud Insights Dockerレジストリからダウンロードされます。インストールが完了すると、NKMOはKubernetesクラスタノードに導入されたOperator互換コレクタを管理してデータを取得します。これには、コレクタのライフサイクルの管理も含まれます。このチェーンに続いて、データがコレクタから取得され、Cloud Insights に送信されます。



== NetApp Kubernetes Monitoring Operatorをインストールする前に

.前提条件
* カスタムまたはプライベートDockerリポジトリを使用している場合は、「カスタムまたはプライベートDockerリポジトリの使用」セクションの手順に従います
* NetApp Kubernetes Monitoring Operatorのインストールは、Kubernetesバージョン1.20以降でサポートされています。
* Cloud Insights がバックエンドストレージを監視しており、KubernetesがDockerコンテナランタイムとともに使用されている場合、Cloud Insights はNFSおよびiSCSIのポッドとPVとストレージのマッピングと指標を表示できます。それ以外のランタイムではNFSのみが表示されます。
* 2022年8月より、NetApp Kubernetes Monitoring Operatorにはポッドのセキュリティポリシー（PSP）のサポートが含まれます。環境でPSPを使用している場合は、最新のNetApp Kubernetes Monitoring Operatorにアップグレードする必要があります。
* OpenShift 4.6以降を実行している場合は、以下の前提条件を満たしていることを確認するだけでなく、以下のOpenShiftの手順に従う必要があります。
* 監視は Linux ノードにのみインストールされます
Cloud Insights では、 Linux を実行している Kubernetes ノードの監視をサポートしています。 Kubernetes ノードセレクタを指定して、これらのプラットフォームで次の Kubernetes ラベルを検索します。


|===


| プラットフォーム | ラベル 


| Kubernetes v1.20以降 | Kubernetes の IO / OS = Linux 


| Rancher + catt.io をオーケストレーション / Kubernetes プラットフォームとして使用 | catt.io/os=linux 
|===
* NetApp Kubernetes Monitoring Operatorとその依存関係（テレグラム、kube-state-metrics、Fluentbitなど）は、Arm64アーキテクチャで実行されているノードではサポートされません。
* 次のコマンドが使用可能である必要があります。curl、kubectl。オプションのインストール手順にはdockerコマンドが必要です。最適な結果を得るには、これらのコマンドをパスに追加してください。kubectlは、少なくとも次のKubernetesオブジェクトにアクセスできるように設定する必要があります。エージェント、クラスタロール、クラスタロールバインド、カスタムリソース定義、導入、 ネームスペース'ロール'ロールバインド'シークレット'サービスアカウント' サービスを提供します。これらの最小クラスタロール権限を持つ.yamlファイルの例については、こちらを参照してください。
* NetApp Kubernetes Monitoring Operatorのインストールに使用するホストは、ターゲットのKubernetesクラスタと通信するようにkubectlを設定し、Cloud Insights 環境にインターネット接続できるようにする必要があります。
* インストール中にプロキシの背後にいる場合、または監視対象のKubernetesクラスタを操作している場合は、「プロキシサポートの設定」セクションの手順に従ってください。
* NetApp Kubernetes Monitoring Operatorは、他のインスタンスとの競合を回避するために独自のkube-state-metricsをインストールします。
監査およびデータレポートを正確に作成するには、Network Time Protocol（NTP；ネットワークタイムプロトコル）またはSimple Network Time Protocol（SNTP；簡易ネットワークタイムプロトコル）を使用してAgentマシンの時刻を同期することを強く推奨します。
* Operatorを再デプロイする場合(つまり、Operatorを更新または置換する場合)は、_new_apiトークンを作成する必要はありません。前のトークンを再利用できます。
* また、最新のNetApp Kubernetes Monitoring Operatorがインストールされていて、更新可能なAPIアクセストークンを使用している場合は、期限切れが近いトークンが新しい/更新されたAPIアクセストークンに自動的に置き換えられます。




== 開始する前に、これらの点に注意してください

を使用してを実行する場合 <<configuring-proxy-support,プロキシ>>を使用してください <<using-a-custom-or-private-docker-repository,カスタムリポジトリ>>またはを使用している <<openshift-instructions,OpenShift>>を参照してください。

以前のインストールからアップグレードする場合は、も参照してください <<をアップグレードして,をアップグレードして>> 情報。



== オペレータの設定

新しいバージョンの演算子では、最も一般的に変更される設定は_AgentConfiguration_customリソースで構成できます。オペレータを配備する前に、_operator-config.yaml_fileを編集して、このリソースを編集できます。このファイルには、一部の設定例がコメントアウトされています。のリストを参照してください link:telegraf_agent_k8s_config_options.html["使用可能な設定"] 演算子の最新バージョン。

次のコマンドを使用してオペレータを配置した後で、このリソースを編集することもできます。

 kubectl -n netapp-monitoring edit AgentConfiguration
展開したオペレータのバージョンがAgentConfigurationをサポートしているかどうかを確認するには、次のコマンドを実行します。

 kubectl get crd agentconfigurations.monitoring.netapp.com
「Error from server (NotFound)」というメッセージが表示された場合は、AgentConfigurationを使用する前にオペレータをアップグレードする必要があります。



=== プロキシサポートを設定しています

環境にプロキシを使用してNetApp Kubernetes Monitoring Operatorをインストールする方法は2つあります。同じプロキシシステムでも、別のプロキシシステムでもかまいません。

* プロキシは、インストールコードスニペット（「curl」を使用）の実行中に、スニペットが実行されるシステムをCloud Insights 環境に接続するために必要です
* ターゲットのKubernetesクラスタがCloud Insights 環境と通信するために必要なプロキシ


これらのいずれかまたは両方にプロキシを使用する場合、NetApp Kubernetesオペレーティングモニタをインストールするには、最初にプロキシがCloud Insights環境との良好な通信を許可するように設定されていることを確認する必要があります。たとえば、Operatorをインストールするサーバ/ VMから、Cloud Insightsにアクセスし、Cloud Insightsからバイナリをダウンロードできるようにする必要があります。

NetApp Kubernetes Operating Monitorのインストールに使用するプロキシとして、オペレータをインストールする前に、_http_proxy/https_proxy_environment変数を設定します。一部のプロキシ環境では'_no_proxy環境変数も設定する必要があります

変数を設定するには、NetApp Kubernetes Monitoring Operatorをインストールする前に、システムで次の手順を実行します。

. 現在のユーザの _https_proxy_ 変数と _http_proxy_environment 変数を設定します。
+
.. セットアップするプロキシに認証（ユーザ名/パスワード）がない場合は、次のコマンドを実行します。
+
 export https_proxy=<proxy_server>:<proxy_port>
.. セットアップするプロキシに認証（ユーザ名/パスワード）が設定されている場合は、次のコマンドを実行します。
+
 export http_proxy=<proxy_username>:<proxy_password>@<proxy_server>:<proxy_port>




KubernetesクラスタがCloud Insights 環境と通信するために使用するプロキシについては、以下の手順をすべて読み、NetApp Kubernetes Monitoring Operatorをインストールします。

NetApp Kubernetes Monitoring Operatorを導入する前に、operator-config.yamlでAgentConfigurationのプロキシセクションを設定します。

[listing]
----
agent:
  ...
  proxy:
    server: <server for proxy>
    port: <port for proxy>
    username: <username for proxy>
    password: <password for proxy>

    # In the noproxy section, enter a comma-separated list of
    # IP addresses and/or resolvable hostnames that should bypass
    # the proxy
    noproxy: <comma separated list>

    isTelegrafProxyEnabled: true
    isFluentbitProxyEnabled: <true or false> # true if Events Log enabled
    isCollectorsProxyEnabled: <true or false> # true if Network Performance and Map enabled
    isAuProxyEnabled: <true or false> # true if AU enabled
  ...
...
----


=== カスタムまたはプライベートのDockerリポジトリを使用する

デフォルトでは、NetApp Kubernetes Monitoring OperatorはCloud Insights リポジトリからコンテナイメージを取得します。監視のターゲットとして使用されているKubernetesクラスタがあり、カスタムまたはプライベートのDockerリポジトリまたはコンテナレジストリからのみコンテナイメージを取得するようにそのクラスタが設定されている場合は、NetApp Kubernetes Monitoring Operatorで必要なコンテナへのアクセスを設定する必要があります。

NetApp Monitoring Operatorのインストールタイルから[Image Pull Snippet]を実行します。このコマンドは、Cloud Insights リポジトリにログインし、オペレータのすべてのイメージ依存関係をプルして、Cloud Insights リポジトリからログアウトします。プロンプトが表示されたら、指定したリポジトリの一時パスワードを入力します。このコマンドは、オプション機能を含む、オペレータが使用するすべてのイメージをダウンロードします。これらの画像がどの機能に使用されるかについては、以下を参照してください。

Core Operator Functionality and Kubernetes Monitoringの略

* ネットアップによる監視
* kube-rbac-proxyの略
* kube-state-metricsの略
* テレグラフ
* distroless-root-user


イベントログ

* Fluent-bit
* kubernetes-event-exporterの略


ネットワークのパフォーマンスとマップ

* ci-net-observerの略


社内のポリシーに従って、オペレータ用の Docker イメージをプライベート / ローカル / エンタープライズ Docker リポジトリにプッシュします。リポジトリ内のこれらのイメージへのイメージタグとディレクトリパスが、Cloud Insights リポジトリ内のイメージタグとディレクトリパスと一致していることを確認します。

operator-deployment.yamlでmonitoring-operatorデプロイメントを編集し、プライベートDockerリポジトリを使用するようにすべてのイメージ参照を変更します。

....
image: <docker repo of the enterprise/corp docker repo>/kube-rbac-proxy:<kube-rbac-proxy version>
image: <docker repo of the enterprise/corp docker repo>/netapp-monitoring:<version>
....
operator-config.yamlのAgentConfigurationを編集して、新しいDockerリポジトリの場所を反映します。プライベートリポジトリ用に新しいimagePullSecretを作成します。詳細については、_ https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/_を参照してください

[listing]
----
agent:
  ...
  # An optional docker registry where you want docker images to be pulled from as compared to CI's docker registry
  # Please see documentation link here: https://docs.netapp.com/us-en/cloudinsights/task_config_telegraf_agent_k8s.html#using-a-custom-or-private-docker-repository
  dockerRepo: your.docker.repo/long/path/to/test
  # Optional: A docker image pull secret that maybe needed for your private docker registry
  dockerImagePullSecret: docker-secret-name
----


=== OpenShift の手順

OpenShift 4.6以降で実行している場合は、_runPrivileged_settingを有効にするには、_operator-config.yaml_でAgentConfigurationを編集する必要があります。

....
# Set runPrivileged to true SELinux is enabled on your kubernetes nodes
runPrivileged: true
....
OpenShiftは、一部のKubernetesコンポーネントへのアクセスをブロックする可能性のある追加のセキュリティレベルを実装する場合があります。



=== 公差と接線（Tolerations and Taints）

_telegraf_、_fluent-bit_、および_net-observer_DaemonSetsは、すべてのノードのデータを正しく収集するために、クラスタ内のすべてのノードでポッドをスケジュールする必要があります。オペレータは、いくつかの既知の*テイント*に耐えられるように設定されています。ノードにカスタムのtaintsを設定して、すべてのノードでポッドが実行されないようにしている場合は、それらのtaintsに* toleration *を作成できます link:telegraf_agent_k8s_config_options.html["（_AgentConfiguration_）をクリックします"]。クラスタ内のすべてのノードにカスタムテイントを適用した場合は、オペレータの導入に必要な許容範囲を追加して、オペレータポッドをスケジュールおよび実行できるようにする必要があります。

Kubernetesの詳細はこちらをご覧ください link:https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/["塗料および耐性"]。



== NetApp Kubernetes Monitoring Operatorをインストールします

image:NKMO-Instructions-1.png[""]
image:NKMO-Instructions-2.png[""]

.NetApp Kubernetes Monitoring Operator Agent を Kubernetes にインストールする手順：
. 一意のクラスタ名およびネームスペースを入力してください。実行中の場合 <<をアップグレードして,をアップグレードして>> 以前のKubernetes Operatorで、同じクラスタ名とネームスペースを使用します。
. これらを入力すると、ダウンロードコマンドスニペットをクリップボードにコピーできます。
. スニペットを a_bash_window に貼り付け、実行します。Operatorインストールファイルがダウンロードされます。スニペットには固有のキーがあり、24時間有効です。
. カスタムリポジトリまたはプライベートリポジトリがある場合は、オプションのImage Pullスニペットをコピーし、a_bash_shellに貼り付けて実行します。画像がプルされたら、プライベートリポジトリにコピーします。必ず同じタグとフォルダ構造を維持してください。_operator-deployment.yaml_のパスと_operator-config.yaml_のDockerリポジトリ設定を更新します。
. 必要に応じて、プロキシやプライベートリポジトリの設定など、使用可能な設定オプションを確認します。あなたはについてもっと読むことができます link:telegraf_agent_k8s_config_options.html["設定オプション"]。
. 準備ができたら、kubectl Applyスニペットをコピーしてダウンロードし、実行してOperatorをデプロイします。
. インストールが自動的に開始されます。完了したら、[_Next_]ボタンをクリックします。
. インストールが完了したら、[_Next_]ボタンをクリックします。また、_operator-secrets.yaml_fileを削除するか、安全に保存してください。


詳細については、をご覧ください <<configuring-proxy-support,プロキシを設定します>>。

詳細については、をご覧ください <<using-a-custom-or-private-docker-repository,カスタム/プライベートDockerリポジトリを使用する>>。

NetApp Kubernetes Monitoring Operatorをインストールすると、Kubernetes EMSログ収集がデフォルトで有効になります。インストール後にこの収集を無効にするには、Kubernetesクラスタの詳細ページの上部にある* Modify Deployment *ボタンをクリックし、[Log collection]の選択を解除します。

image:K8s_Modify_Deployment_Screen.png["[Modify Deployment]画面に[Log Collection]のチェックボックスが表示されている。"]

この画面には、現在のログ収集ステータスも表示されます。次の状態が考えられます。

* 無効
* 有効
* Enabled -インストールを実行中です
* Enabled -オフライン
* 有効-オンライン
* エラー- APIキーに十分な権限がありません




== をアップグレードして

. 既存の構成をバックアップします。
+
 kubectl --namespace ci-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml
. K8sオペレータベースの監視解決策 のインストール中に使用するK8sクラスタ名を保存して、データの継続性を確保します。
+
CIにKubernetesクラスタの名前を覚えていない場合は、次のコマンドラインを使用して、保存した構成からクラスタを抽出できます。

+
 cat /tmp/telegraf-configs.yaml | grep kubernetes_cluster | head -2
. スクリプトベースの監視を削除します
+
Kubernetes 上のスクリプトベースのエージェントをアンインストールするには、次の手順を実行します。

+
モニタリングネームスペースが Telegraf 専用に使用されている場合：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
+
 kubectl delete ns ci-monitoring
+
モニタリングネームスペースが Telegraf 以外の目的で使用されている場合：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
. <<installing-the-netapp-kubernetes-monitoring-operator,をインストールします>> 現在の演算子。必ず、上記の手順1と同じクラスタ名を使用してください。



NOTE: 以前にインストールしたスクリプトベースのKubernetesエージェントでを実行している場合は、を実行する必要があります <<をアップグレードして,アップグレード>> を使用して、NetApp Kubernetes Monitoring Operatorに接続します。



=== 廃止されたスクリプトベースのエージェントを削除します

これらのコマンドは、デフォルトの名前空間「 CI-monitoring 」を使用していることに注意してください。  独自のネームスペースを設定した場合は、それらのネームスペースと、以降のすべてのコマンドおよびファイルを置き換えます。

Kubernetes上のスクリプトベースのエージェント（NetApp Kubernetes Monitoring Operatorへのアップグレードなど）をアンインストールするには、次の手順を実行します。

モニタリングネームスペースが Telegraf 専用に使用されている場合：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 kubectl delete ns ci-monitoring
モニタリングネームスペースが Telegraf 以外の目的で使用されている場合：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf


== オペレータのチューニング

NetApp Kubernetes Monitoring Operatorは、カスタムリソースの特定の変数を微調整することで、最適なパフォーマンスを実現するように調整できます。調整可能な変数の説明とリストについては、インストールパッケージに含まれているREADMEファイルを参照してください。オペレータのインストールが完了したら、次のコマンドを使用してREADMEを参照します。

 sudo -E -H ./<installation_script_name> --install

NOTE: オペレータのチューニングは、Cloud Insights フェデラルエディションでは使用できません

NetApp Kubernetes Monitoring Operatorは、カスタムリソースの特定の変数を微調整することで、最適なパフォーマンスを実現するように調整できます。  設定可能な変数については、次の表を参照してください。

これらの値を変更するには、次のコマンドを使用してエージェントCRを編集します（ネームスペースには<namespace> を置き換えます）。

 kubectl edit agent agent-monitoring-netapp -n <namespace>
CR仕様は次の形式に従います。

[listing]
----
 - name: <plugin-name>
   ...
   substitutions:
   - key: <variable-name>
     value: <desired-value>
     ...
----
「デフォルトCRに含まれる」に「はい」とマークされている項目は、すでにエージェントCRに存在し、それぞれのプラグインの下に表示されます。"no"とマークされた項目は、付属のデフォルト置換の例に従って手動で追加する必要があります。



=== リソース関連の変数

を参照してください https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/[]	Kubernetesのリソースについては、を参照してください。

|===


| 変数名（Variable Name） | プラグイン名 | デフォルトのCRに含まれています | 説明 


| DS_CPU_LITION_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetes CPU制限 


| DS_MEM_LITION_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetesメモリ制限- DS 


| DS_CPU_REQUERY_PLACEHOLDER | エージェント | はい。 | テレグラムのCPU要求- DS 


| DS_MEM_REQUERY_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetesメモリ要求- DS 


| rs_cpu_limits_placeholder | エージェント | はい。 | テレグラムのKubernetes CPU制限： 


| RS_MEM_LITION_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetesメモリ制限- RS 


| rs_cpu_request_placeholder | エージェント | はい。 | テレグラム用のKubernetes CPU要求- RS 


| RS_MEM_REQUERY_PLACEHOLDER | エージェント | はい。 | テレグラムに対するKubernetesメモリ要求 


| KSM_CPU_REQUERY_PLACEHOLDER： | KSM | はい。 | kube-state-metrics導入用のKubernetes CPU要求 


| KSM_MEM_REQUERY_PLACEHOLDER： | KSM | はい。 | kube-state-metrics導入用のKubernetes CPU要求 
|===


=== Telegrafに関連する変数

を参照してください https://github.com/influxdata/telegraf/blob/master/docs/CONFIGURATION.md#agent[] テレグラム変数の詳細については、を参照してください。

|===


| プレースホルダー | プラグイン名 | デフォルトのCRに含まれています | 説明 


| collection_interval_placeholder | エージェント | いいえ | （テレグラム間隔、タイプ間隔を設定）：テレグラムがすべてのプラグインの入力間で待機するデフォルトの時間。有効な時間単位は、ns、us（または µ s）、ms、s、m、高さ 


| round_interval_placeholder | エージェント | いいえ | （テレグラムのround_intervalを設定し、boolean型）間隔の倍数でメトリックを収集します 


| metric_batch_size_placeholder | エージェント | いいえ | （は、テレグラムのmetric_batch_size、タイプintを設定します）出力テレグラムの最大レコード数は、1つのバッチで書き込まれます 


| metric_buffer_limit_cplaceholder | エージェント | いいえ | （は、テレグラムのmetric_buffer_limit、タイプintを設定します）出力テレグラムの最大レコード数は、正常な書き込みが完了するまでキャッシュされます 


| collection_jitter_placeholder | エージェント | いいえ | （は、テレグラムの収集ジッタ、タイプ間隔を設定します）。各プラグインは、入力を収集する前に、スケジュールされた収集時間と、その時間+ Collection_jitterの間でランダムな時間を待機します 


| Precision_placeholder | エージェント | いいえ | （テレグラム精度、タイプ間隔を設定）：収集されたメトリックは指定された精度に丸められ、「0」精度に設定された場合は、間隔で指定された単位で設定されます 


| flush_interval_placeholder | エージェント | いいえ | （テレグラムフラッシュ間隔、タイプ間隔を設定します）：テレグラムが出力間で待機するデフォルトの時間。 


| flush_jitter_placeholder | エージェント | いいえ | （は、テレグラムフラッシュジッタ、タイプインターバルを設定します）。各出力は、出力を書き込む前に、スケジュールされた書き込み時間とその時間+フラッシュジッタの間にランダムな時間を待機します 
|===


=== その他の変数

|===


| プレースホルダー | プラグイン名 | デフォルトのCRに含まれています | 説明 


| CL_CMD_PLACEHOLDER | エージェント | はい。 | さまざまなリソースのダウンロードに使用するcurlコマンド。例）「curl」または「curl -k」 
|===