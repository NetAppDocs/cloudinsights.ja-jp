---
sidebar: sidebar 
permalink: task_config_telegraf_agent_k8s.html 
keywords: telegraf, installation, install, agent, telegraf agent, kubernetes, eks, operator, k8s 
summary: Cloud Insights は、 Kubernetes で統合データを収集するエージェントとして Telegraf をサポートしています。 
---
= NetApp Kubernetes Monitoring Operatorの設定
:allow-uri-read: 


[role="lead"]
Cloud Insights では、などの多くのコンポーネントが使用されます link:https://docs.fluentbit.io/manual["流暢なビット"] および link:https://docs.influxdata.com/telegraf/["Tegraf"]をクリックしてください。Telegraf はプラグインベースのサーバエージェントで、指標、イベント、ログの収集とレポートに使用できます。入力プラグインは、システム /OS に直接アクセスするか、サードパーティ API を呼び出すか、設定されたストリームをリスニングすることによって、エージェントに必要な情報を収集するために使用されます（例：） Kafka や StatsD など）を参照してください。出力プラグインは、収集した指標、イベント、およびログをエージェントから Cloud Insights に送信するために使用します。


toc::[]
Cloud Insights では、Kubernetesコレクション向けにNetApp Kubernetes Monitoring Operator *（NKMO）を提供しています。データコレクタを追加するときは、「Kubernetes」タイルを選択するだけです。

image:kubernetes_tile.png["Kubernetes Data Collectorのタイル"]



== NetApp Kubernetes Monitoring Operatorをインストールする前に

[[nkmoversion]]
.前提条件
* 次のコンポーネントバージョンに注意してください。これらは、NetApp Kubernetes Monitoring Operatorに現在含まれているバージョンです。特に、これらのバージョンを使用している場合は注意が必要です <<using-a-custom-or-private-docker-repository,カスタムまたはプライベートのDockerリポジトリを使用する>>：
+
** Telegraf :1.24.0
** kube-rbacプロキシ：v1.13.0
** kube-state-metrics：v2.6.0
** 流出ビット:1.9.8
** Kubernetesイベントエクスポータ：0.10


* NetApp Kubernetes Monitoring Operatorインストールは、Kubernetesバージョン1.20以降でサポートされます。
* Cloud Insights がバックエンドストレージを監視しており、KubernetesをDockerコンテナランタイムで使用している場合、Cloud Insights では、NFSとiSCSIについてポッド/ PV /ストレージ間のマッピングを表示できます。その他の実行時間ではiSCSIのみが表示されます。
* 2022年8月より、NetApp Kubernetes Monitoring Operatorにはポッドのセキュリティポリシー（PSP）のサポートが含まれます。実行する必要があります <<をアップグレードして,アップグレード>> PSPを使用する環境の場合は、最新のNetApp Kubernetes Monitoring Operatorに接続します。
* OpenShift 4.6以降で実行している場合は、これらの前提条件を満たしていることを確認するだけでなく、以下の* OpenShift Instructions *に従う必要があります。
* 監視は Linux ノードにのみインストールされます
+
Cloud Insights では、 Linux を実行している Kubernetes ノードの監視をサポートしています。 Kubernetes ノードセレクタを指定して、これらのプラットフォームで次の Kubernetes ラベルを検索します。

+
|===


| プラットフォーム | ラベル 


| Kubernetes v1.20以降 | Kubernetes の IO / OS = Linux 


| Rancher + catt.io をオーケストレーション / Kubernetes プラットフォームとして使用 | catt.io/os=linux 
|===
* NetApp Kubernetes Monitoring Operatorとその依存関係（テレグラム、kube-state-metrics、Fluentbitなど）は、Arm64アーキテクチャで実行されているノードではサポートされません。
* 次のコマンドを使用できる必要があります。 _curl 、 _sudo 、 _openssl 、 _sha256sum_ 、および _kubectl_.最適な結果を得るには、これらのコマンドをパスに追加してください。
* NetApp Kubernetes Monitoring Operatorインストールに使用するホストには、ターゲットのKubernetesクラスタと通信し、Cloud Insights 環境とインターネットに接続できるよう、_kubectl_configuredが必要です。このホストがCloud Insights にアクセスするためにプロキシを必要とする場合は、の手順に従います <<configuring-proxy-support,プロキシサポートを設定しています>> セクション。
* NetApp Kubernetes Monitoring Operatorは、他のインスタンスとの競合を回避するために独自のkube-state-metricsをインストールします。
* インストール中または監視対象のKubernetesクラスタを操作中にプロキシの背後にいる場合は、の手順に従ってください <<configuring-proxy-support,プロキシサポートを設定しています>> セクション。
* Kubernetes クラスタのロールおよびロールのバインドを作成する権限が必要です。


正確な監査およびデータレポートを作成するためには、 * Network Time Protocol （ NTP; ネットワークタイムプロトコル） * または * Simple Network Time Protocol （ SNTP ） * を使用して、 Agent マシンの時刻を同期することを強くお勧めします。



== 開始する前に、これらの点に注意してください

を使用してを実行する場合 <<configuring-proxy-support,プロキシ>>を使用してください <<using-a-custom-or-private-docker-repository,カスタムリポジトリ>>またはを使用している <<openshift-instructions,OpenShift>>を参照してください。

以前のインストールからアップグレードする場合は、も参照してください <<をアップグレードして,をアップグレードして>> 情報。

Agent をインストールする前にインストールファイルを確認する場合は、「バージョン情報」を参照してください <<verifying-kubernetes-checksums,Kubernetes のチェックサムの検証>>。



=== プロキシサポートを設定しています

環境にプロキシを使用してNetApp Kubernetes Monitoring Operatorをインストールする方法は2つあります。同じプロキシシステムでも、別のプロキシシステムでもかまいません。

* プロキシは、インストールコードスニペット（「curl」を使用）の実行中に、スニペットが実行されるシステムをCloud Insights 環境に接続するために必要です
* ターゲットのKubernetesクラスタがCloud Insights 環境と通信するために必要なプロキシ


これらのいずれか、または両方にプロキシを使用する場合は、NetApp Kubernetes Operating Monitorをインストールするために、まずCloud Insights 環境との良好な通信を可能にするようにプロキシが設定されていることを確認する必要があります。プロキシがあり、オペレータをインストールするサーバ/VMからCloud Insights にアクセスできる場合は、プロキシが適切に設定されている可能性があります。

NetApp Kubernetes Operating Monitorのインストールに使用するプロキシとして、オペレータをインストールする前に、_http_proxy/https_proxy_environment変数を設定します。一部のプロキシ環境では'_no_proxy環境変数も設定する必要があります

変数を設定するには、NetApp Kubernetes Monitoring Operatorをインストールする前に、システムで次の手順を実行します。

. 現在のユーザの _https_proxy_ 変数と _http_proxy_environment 変数を設定します。
+
 export https_proxy=<proxy_server>:<proxy_port>
. /etc/default/テレ グラム af_ を作成し、 _https_proxy_/or_http_proxy_variable の定義を挿入します。
+
 https_proxy=<proxy_server>:<proxy_port>


KubernetesクラスタがCloud Insights 環境と通信するために使用するプロキシについては、以下の手順をすべて読み、NetApp Kubernetes Monitoring Operatorをインストールします。

設定を完了するには、NetApp Kubernetes Monitoring Operatorをインストールしたあと、システム*で次の手順を実行します。

まず、 _agent-monitoring -NetApp_file を開き、編集します。

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp
このファイルの*spec:*セクションを探し、次のコードを追加します。

[listing]
----
 proxy:

 # If an AU is enabled on your cluster for monitoring
 # by Cloud Insights, then isAuProxyEnabled should be set to true:
  isAuProxyEnabled: <true or false>

 # If your Operator install is behind a corporate proxy,
 # isTelegrafProxyEnabled should be set to true:
  isTelegrafProxyEnabled: <true or false>

 # If LOGS_COLLECTION is enabled on your cluster for monitoring
 # by CI, then isFluentbitProxyEnabled should be set to true:
  isFluentbitProxyEnabled: <true or false>

 # Set the following values according to your proxy login:
  password: <password for proxy, optional>
  port: <port for proxy>
  server: <server for proxy>
  username: <username for proxy, optional

 # In the noProxy section, enter a comma-separated list of
 # IP addresses and/or resolvable hostnames that should bypass
 # the proxy:
  noProxy: <comma separated list>
----


=== カスタムまたはプライベートのDockerリポジトリを使用する

デフォルトでは、NetApp Kubernetes Monitoring Operator設定は、パブリックレジストリからコンテナイメージを取得します。監視のターゲットとして使用するKubernetesクラスタがある場合は、 また、カスタムまたはプライベートのDockerリポジトリまたはコンテナレジストリからコンテナイメージのみを取得するようにクラスタを設定した場合、必要なコマンドを実行できるように、NetApp Kubernetes Monitoring Operatorで必要なコンテナへのアクセスを設定する必要があります。

次の手順に従って、レジストリにコンテナイメージを事前に配置し、NetApp Kubernetes Monitoring Operator設定を変更してこれらのイメージにアクセスします。次のコマンドで、選択したインストールネームスペースを、デフォルトのネームスペースである「NetApp-monitoring」と異なる場合は置き換えてください。

. Docker シークレットを取得します。
+
 kubectl -n netapp-monitoring get secret docker -o yaml
. 上記のコマンドの出力から、 _.dockerconfigjson ： _ の値をコピーして貼り付けます。
. Docker シークレットをデコードします。
+
 echo <paste from _.dockerconfigjson:_ output above> | base64 -d


の出力は次のJSON形式になります。

....
{ "auths":
  {"docker.<cluster>.cloudinsights.netapp.com" :
    {"username":"<tenant id>",
     "password":"<password which is the CI API token>",
     "auth"    :"<encoded username:password basic auth token. This is internal to docker>"}
  }
}
....
Docker リポジトリにログインします。

....
docker login docker.<cluster>.cloudinsights.netapp.com (from step #2) -u <username from step #2>
password: <password from docker secret step above>
....
オペレータ用のDockerイメージをCloud Insights から取得します。NetApp Monitoringのバージョン番号が最新であることを確認します。

 docker pull docker.<cluster>.cloudinsights.netapp.com/netapp-monitoring:<version>
次のコマンドを使用して、_NetApp-Monitoring_<version>フィールドを確認します。

 kubectl -n netapp-monitoring get deployment monitoring-operator | grep "image:"
社内のポリシーに従って、オペレータ用の Docker イメージをプライベート / ローカル / エンタープライズ Docker リポジトリにプッシュします。

オープンソースの依存関係をすべてプライベート Docker レジストリにダウンロードします。次のオープンソースイメージをダウンロードする必要があります。を参照してください <<before-installing-the-netapp-kubernetes-monitoring-operator,前提条件>> これらのコンポーネントの最新バージョンについては、上記の項を参照してください。

....
docker.io/telegraf
gcr.io/kubebuilder/kube-rbac-proxy
k8s.gcr.io/kube-state-metrics/kube-state-metrics
....
FLUENT ビットが有効になっている場合は、次のファイルもダウンロードしてください。

....
docker.io/fluent-bit
docker.io/kubernetes-event-exporter
....
エージェント CR を編集して新しい Docker repo の場所を反映し、自動アップグレードを無効にします（有効な場合）。

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp
 enableAutoUpgrade: false
....
docker-repo: <docker repo of the enterprise/corp docker repo>
dockerRepoSecret: <optional: name of the docker secret of enterprise/corp docker repo, this secret should be already created on the k8s cluster in the same namespace>
....
spec セクションで、次の変更を行います。

....
spec:
  telegraf:
    - name: ksm
      substitutions:
        - key: k8s.gcr.io
          value: <same as "docker-repo" field above>
....


=== OpenShift の手順

OpenShift 4.6以降で実行している場合は、「特権モード」設定を変更する必要があります。次のコマンドを実行して、エージェントを開いて編集します。「 NetApp Monitoring 」以外のネームスペースを使用している場合は、コマンドラインでそのネームスペースを指定します。

 kubectl edit agent agent-monitoring-netapp -n netapp-monitoring
ファイルで、 change_privileged-mode ： false_to _privileged-users mode ： true_

OpenShiftは、一部のKubernetesコンポーネントへのアクセスをブロックする可能性のある追加のセキュリティレベルを実装する場合があります。



== NetApp Kubernetes Monitoring Operatorをインストールします

image:NKMO_Install_Instructions.png["オペレータベースのインストール"]

.NetApp Kubernetes Monitoring Operator Agent を Kubernetes にインストールする手順：
. 一意のクラスタ名およびネームスペースを入力してください。実行中の場合 <<をアップグレードして,をアップグレードして>> スクリプトベースのエージェントまたは以前のKubernetes Operatorから、同じクラスタ名とネームスペースを使用します。
. これらのコードを入力したら、エージェントインストーラスニペットをコピーできます
. このスニペットをクリップボードにコピーするには、ボタンをクリックします。
. スニペットを a_bash_window に貼り付け、実行します。スニペットには固有のキーがあり、24時間有効です。
. インストールが自動的に開始されます。完了したら、 _Complete Setup_ ボタンをクリックします。



NOTE: セットアップは完了していません <<configuring-proxy-support,プロキシを設定します>>。


NOTE: カスタムリポジトリを使用している場合は、の手順に従う必要があります <<using-a-custom-or-private-docker-repository,カスタム / プライベート Docker リポジトリを使用>>。



== をアップグレードして


NOTE: 以前にスクリプトベースのエージェントをインストールしている場合は、NetApp Kubernetes Monitoring Operatorにアップグレードする必要があります。



=== スクリプトベースのエージェントからNetApp Kubernetes Monitoring Operatorへのアップグレード

テレグラムエージェントをアップグレードするには、次の手順に従います。

. Cloud Insights が認識するクラスタ名をメモしておきます。クラスタ名を確認するには、次のコマンドを実行します。名前空間がデフォルト（_CI-MOTing_）でない場合は、適切な名前空間を置き換えます。
+
 kubectl -n ci-monitoring get cm telegraf-conf -o jsonpath='{.data}' |grep "kubernetes_cluster ="
. 既存の構成をバックアップします。
+
 kubectl --namespace ci-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml
. K8sオペレータベースの監視解決策 のインストール中に使用するK8sクラスタ名を保存して、データの継続性を確保します。
+
CIにKubernetesクラスタの名前を覚えていない場合は、次のコマンドラインを使用して、保存した構成からクラスタを抽出できます。

+
 cat /tmp/telegraf-configs.yaml | grep kubernetes_cluster | head -2
. スクリプトベースの監視を削除します
+
Kubernetes 上のスクリプトベースのエージェントをアンインストールするには、次の手順を実行します。

+
モニタリングネームスペースが Telegraf 専用に使用されている場合：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
+
 kubectl delete ns ci-monitoring
+
モニタリングネームスペースが Telegraf 以外の目的で使用されている場合：

+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
. <<installing-the-netapp-kubernetes-monitoring-operator,をインストールします>> 現在の演算子。必ず、上記の手順1と同じクラスタ名を使用してください。




=== 最新のNetApp Kubernetes Monitoring Operatorにアップグレードします

オペレータベースのインストールアップグレードの場合は、次のコマンドを実行します。

* Cloud Insights が認識するクラスタ名をメモしておきます。クラスタ名を確認するには、次のコマンドを実行します。ネームスペースがデフォルト（_NetApp-monitoring _）以外の場合は、適切なネームスペースに置き換えます。
+
 kubectl -n netapp-monitoring get agent -o jsonpath='{.items[0].spec.cluster-name}'
* 既存の構成をバックアップします。
+
 kubectl --namespace netapp-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml


<<to-remove-the-netapp-kubernetes-monitoring-operator,をアンインストールします>> 現在の演算子。

<<installing-the-netapp-kubernetes-monitoring-operator,をインストールします>> 最新の演算子。カスタムリポジトリを設定した場合は、同じクラスタ名を使用し、新しいコンテナイメージを取得するようにしてください。



== NetApp Kubernetes Monitoring Operatorを停止および開始します

NetApp Kubernetes Monitoring Operatorを停止するには、次の手順を実行します

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=0
NetApp Kubernetes Monitoring Operatorを開始するには、次の手順を実行します

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=1


== アンインストール中です


NOTE: 以前にインストールしたスクリプトベースのKubernetesエージェントでを実行している場合は、を実行する必要があります <<をアップグレードして,アップグレード>> を使用して、NetApp Kubernetes Monitoring Operatorに接続します。



=== 廃止されたスクリプトベースのエージェントを削除します

これらのコマンドは、デフォルトの名前空間「 CI-monitoring 」を使用していることに注意してください。独自のネームスペースを設定した場合は、それらのネームスペースと、以降のすべてのコマンドおよびファイルを置き換えます。

Kubernetes上のスクリプトベースのエージェント（NetApp Kubernetes Monitoring Operatorへのアップグレードなど）をアンインストールするには、次の手順を実行します。

モニタリングネームスペースが Telegraf 専用に使用されている場合：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 kubectl delete ns ci-monitoring
モニタリングネームスペースが Telegraf 以外の目的で使用されている場合：

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf


=== をクリックして、NetApp Kubernetes Monitoring Operatorを削除します

NetApp Kubernetes Monitoring Operatorのデフォルトのネームスペースは、「NetApp Monitoring」です。独自のネームスペースを設定した場合は、それらのネームスペースと、以降のすべてのコマンドおよびファイルを置き換えます。

新しいバージョンの監視オペレータは、次のコマンドを使用してアンインストールできます。

....
kubectl delete agent -A -l installed-by=nkmo-<name-space>
kubectl delete ns,clusterrole,clusterrolebinding,crd -l installed-by=nkmo-<name-space>
....
最初のコマンドが「リソースが見つかりません」を返した場合は、次の手順に従って古いバージョンの監視オペレータをアンインストールします。

次の各コマンドを順番に実行します。現在のインストール状況によっては、これらのコマンドの一部で「オブジェクトが見つかりません」というメッセージが返される場合があります。これらのメッセージは無視してかまいません。

....
kubectl -n <NAMESPACE> delete agent agent-monitoring-netapp
kubectl delete crd agents.monitoring.netapp.com
kubectl -n <NAMESPACE> delete role agent-leader-election-role
kubectl delete clusterrole agent-manager-role agent-proxy-role agent-metrics-reader <NAMESPACE>-agent-manager-role <NAMESPACE>-agent-proxy-role <NAMESPACE>-cluster-role-privileged
kubectl delete clusterrolebinding agent-manager-rolebinding agent-proxy-rolebinding agent-cluster-admin-rolebinding <NAMESPACE>-agent-manager-rolebinding <NAMESPACE>-agent-proxy-rolebinding <NAMESPACE>-cluster-role-binding-privileged
kubectl delete <NAMESPACE>-psp-nkmo
kubectl delete ns <NAMESPACE>
....
スクリプトベースの Tegraf インストール用に手動で作成した Security Context Constraint の場合は、次の手順を実行します。

 kubectl delete scc telegraf-hostaccess


== Kubeステートメトリックについて

NetApp Kubernetes Monitoring Operatorは、kube-state-metricsを自動的にインストールします。ユーザによる操作は必要ありません。



=== kube-state-metrics カウンタ

これらのkubbeステートメトリックカウンタの情報にアクセスするには、次のリンクを使用します。

. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/configmap-metrics.md["ConfigMap メトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/daemonset-metrics.md["DemonSet メトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/deployment-metrics.md["導入メトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md["入力メトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/namespace-metrics.md["ネームスペース指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md["ノードのメトリックス"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolume-metrics.md["永続的ボリューム指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolumeclaim-metrics.md["永続的ボリューム要求の指標"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md["ポッドのメトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicaset-metrics.md["ReplicaSet メトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/secret-metrics.md["シークレットメトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/service-metrics.md["サービスメトリック"]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/statefulset-metrics.md["Stat助け Set メトリック"]




== Kubernetes のチェックサムの検証

Cloud Insights エージェントのインストーラで整合性チェックが実行されますが、ダウンロードしたアーティファクトのインストールまたは適用前に独自の検証を実行したいユーザもいます。デフォルトのダウンロードおよびインストールではなく、ダウンロードのみの操作を実行するには、 UI から取得したエージェントインストールコマンドを編集し、末尾の「インストール」オプションを削除します。

次の手順を実行します。

. 指示に従ってエージェントインストーラスニペットをコピーします。
. スニペットをコマンドウィンドウに貼り付ける代わりに、テキストエディタに貼り付けます。
. コマンドから末尾の「--install」を削除します。
. コマンド全体をテキストエディタからコピーします。
. 次に、コマンドウィンドウ（作業ディレクトリ内）に貼り付けて実行します。
+
** Download and install （デフォルト）：
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download –-install
** ダウンロードのみ：
+
 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download




download-only コマンドを使用すると、必要なアーティファクトがすべて Cloud Insights から作業ディレクトリにダウンロードされます。アーティファクトには次のものがありますが、これらに限定することはできません。

* インストールスクリプト
* 環境ファイル
* YAML ファイル
* 署名済みチェックサムファイル（ SHA256 署名）
* 署名の検証に使用する PEM ファイル（ NetApp_cert.pem ）


インストールスクリプト、環境ファイル、 YAML ファイルは、目視検査を使用して検証できます。

PEM ファイルは、フィンガープリントが次のようになっていることを確認することで検証できます。

 E5:FB:7B:68:C0:8B:1C:A9:02:70:85:84:C2:74:F8:EF:C7:BE:8A:BC
具体的には、

 openssl x509 -fingerprint -sha1 -noout -inform pem -in netapp_cert.pem
署名済みチェックサムファイルは、 PEM ファイルを使用して確認できます。

 openssl smime -verify -in sha256.signed -CAfile netapp_cert.pem -purpose any
すべてのアーティファクトが正常に検証されたら、次のコマンドを実行してエージェントのインストールを開始できます。

 sudo -E -H ./<installation_script_name> --install


== オペレータのチューニング

NetApp Kubernetes Monitoring Operatorは、カスタムリソースの特定の変数を微調整することで、最適なパフォーマンスを実現するように調整できます。設定可能な変数については、次の表を参照してください。

これらの値を変更するには、次のコマンドを使用してエージェントCRを編集します（ネームスペースには<namespace> を置き換えます）。

 kubectl edit agent agent-monitoring-netapp -n <namespace>
CR仕様は次の形式に従います。

[listing]
----
 - name: <plugin-name>
   ...
   substitutions:
   - key: <variable-name>
     value: <desired-value>
     ...
----
「デフォルトCRに含まれる」に「はい」とマークされている項目は、すでにエージェントCRに存在し、それぞれのプラグインの下に表示されます。"no"とマークされた項目は、付属のデフォルト置換の例に従って手動で追加する必要があります。



=== リソース関連の変数

を参照してください https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/[] Kubernetesのリソースについては、を参照してください。

|===


| 変数名（Variable Name） | プラグイン名 | デフォルトのCRに含まれています | 説明 


| DS_CPU_LITION_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetes CPU制限 


| DS_MEM_LITION_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetesメモリ制限- DS 


| DS_CPU_REQUERY_PLACEHOLDER | エージェント | はい。 | テレグラムのCPU要求- DS 


| DS_MEM_REQUERY_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetesメモリ要求- DS 


| rs_cpu_limits_placeholder | エージェント | はい。 | テレグラムのKubernetes CPU制限： 


| RS_MEM_LITION_PLACEHOLDER | エージェント | はい。 | テレグラムのKubernetesメモリ制限- RS 


| rs_cpu_request_placeholder | エージェント | はい。 | テレグラム用のKubernetes CPU要求- RS 


| RS_MEM_REQUERY_PLACEHOLDER | エージェント | はい。 | テレグラムに対するKubernetesメモリ要求 


| KSM_CPU_REQUERY_PLACEHOLDER： | KSM | はい。 | kube-state-metrics導入用のKubernetes CPU要求 


| KSM_MEM_REQUERY_PLACEHOLDER： | KSM | はい。 | kube-state-metrics導入用のKubernetes CPU要求 
|===


=== Telegrafに関連する変数

を参照してください https://github.com/influxdata/telegraf/blob/master/docs/CONFIGURATION.md#agent[] テレグラム変数の詳細については、を参照してください。

|===


| プレースホルダー | プラグイン名 | デフォルトのCRに含まれています | 説明 


| collection_interval_placeholder | エージェント | いいえ | （テレグラム間隔、タイプ間隔を設定）：テレグラムがすべてのプラグインの入力間で待機するデフォルトの時間。有効な時間単位は、ns、us（または µ s）、ms、s、m、高さ 


| round_interval_placeholder | エージェント | いいえ | （テレグラムのround_intervalを設定し、boolean型）間隔の倍数でメトリックを収集します 


| metric_batch_size_placeholder | エージェント | いいえ | （は、テレグラムのmetric_batch_size、タイプintを設定します）出力テレグラムの最大レコード数は、1つのバッチで書き込まれます 


| metric_buffer_limit_cplaceholder | エージェント | いいえ | （は、テレグラムのmetric_buffer_limit、タイプintを設定します）出力テレグラムの最大レコード数は、正常な書き込みが完了するまでキャッシュされます 


| collection_jitter_placeholder | エージェント | いいえ | （は、テレグラムの収集ジッタ、タイプ間隔を設定します）。各プラグインは、入力を収集する前に、スケジュールされた収集時間と、その時間+ Collection_jitterの間でランダムな時間を待機します 


| Precision_placeholder | エージェント | いいえ | （テレグラム精度、タイプ間隔を設定）：収集されたメトリックは指定された精度に丸められ、「0」精度に設定された場合は、間隔で指定された単位で設定されます 


| flush_interval_placeholder | エージェント | いいえ | （テレグラムフラッシュ間隔、タイプ間隔を設定します）：テレグラムが出力間で待機するデフォルトの時間。 


| flush_jitter_placeholder | エージェント | いいえ | （は、テレグラムフラッシュジッタ、タイプインターバルを設定します）。各出力は、出力を書き込む前に、スケジュールされた書き込み時間とその時間+フラッシュジッタの間にランダムな時間を待機します 
|===


=== その他の変数

|===


| プレースホルダー | プラグイン名 | デフォルトのCRに含まれています | 説明 


| CL_CMD_PLACEHOLDER | エージェント | はい。 | さまざまなリソースのダウンロードに使用するcurlコマンド。例）「curl」または「curl -k」 
|===


== トラブルシューティング

NetApp Kubernetes Monitoring Operatorのセットアップで問題が発生した場合の対処方法を次に示します。

[cols="2*"]
|===
| 問題 | 次の操作を実行します 


| Kubernetes 永続ボリュームと対応するバックエンドストレージデバイスの間にハイパーリンク / 接続がありません。My Kubernetes Persistent Volume がストレージサーバのホスト名を使用して設定されます。 | 手順に従って既存の Tegraf エージェントをアンインストールし、最新の Tegraf エージェントを再インストールします。Tegrafバージョン2.0以降を使用していて、KubernetesクラスタストレージがCloud Insights によってアクティブに監視されている必要があります。 


| 次のようなログにメッセージが表示されます。 E0901 15 ： 21 ： 39.96145 1 reflector.GO ： 178]k81.io/kube-state/internal/store/Builder.GO ： 352 ： Failed to list *v1.MutatingWebhookConfiguration ： 8s could not find the requested resource E0901 15:15:2ku161781. | これらのメッセージは、1.20より前のバージョンのKubernetesでkube-state-metricsバージョン2.0.0以上を実行している場合に発生する可能性があります。Kubernetes のバージョンを取得するには、次の Leubectl version_ kbe-state-metrics バージョンを取得します。 _kubectl デプロイ /kube-state-metrics -o jsonpath='{.image}'_ これらのメッセージが発生しないようにするには、 kube-state-metrics デプロイを修正して、次の Leases 設定を具体的に無効にしてください。 _hookates_web_volumeconfigurations resources= 証明リクエスト , configmaps,cronjobs,demonsets,horizontalscalers,ingleers,jobs,limitrange,scapers,networkpolicies , nodes,persistentvolumes,persistentvolumesalims,persistentvolumes,podeters, replicaSets,replicaSets,replicationcontrollers ,residetodポッド ,residetappeditors,appers,uns,uns,uns,uns,sets,uns,uns,uns,uns,uns,sets,uns,sets,uns,sets,uns,uns,sets,uns,uns,sets,uns,uns,uns,wodecodeclieticecodetics,sets,sets,sets,sets,uns,sets,uns,uns,sets,sets,sets,un 検証する Web フック設定 ' ボリュームの添付ファイル 


| Telegraf から次のようなエラーメッセージが表示されますが、 Telegraf は起動して実行されます。 Oct 11 14 ： 23 ： 41 IP-172-39-47 systemd[1] ： InfluxDB への指標の報告用に、プラグイン駆動型のサーバーエージェントを起動しました。10 月 11 日 14 ： 23 ： 41 IP-172-41-39-47 テレグラム [1827] ： time="2021 - 10-11T14 ： 23 ： 41Z" level= error msg=" キャッシュディレクトリの作成に失敗しました。/etc/テレ グラム /.cache/snowflake 、 err: mkdir /etc/テレ グラム f/.ca che: 許可が拒否されました。ignored \n" func = "gosnowfleke. (*defaultLogger).Errorf" file="log. go:120" Oct 11 14:23:41 IP-172-21-39-47 TEテレ グラフ [1827]: time="2021 - 10-11T14:23:41Z" level=error.msg=" 失敗しました。無視されます。/etc/テレ グラム /.cache/snowflake/ocspa_response_cache.json を開きます。ファイルまたはディレクトリがありません \n" func="gosnowflake.(*defaultLogger).Errorf" file="log.go:120"Oct. 1114:23:41 IP-172-41-39-47 テレグラム [1827:1127]~21-21Z: Telegraf 1.19.3 を起動しています | これは問題と呼ばれています。を参照してください link:https://github.com/influxdata/telegraf/issues/9407["この GitHub の記事"] 詳細：Tegraf が起動して動作している限り、ユーザはこのエラーメッセージを無視できます。 


| Kubernetes で、 Telegraf ポッドが次のエラーを報告しています。 "Error in processing mountstats info: failed to open mountstats file: /hostfs /proc/1/mountstats 、 error: open /hostfs /proc/1/mountstats ： permission denied" | SELinux が有効で強制されている場合、 Telegraf ポッドが Kubernetes ノードの /proc/1/mountstats ファイルにアクセスできない可能性があります。この制限を緩和するには、エージェントを編集します (`kubectl edit agent agent-monitoring-netapp`）を使用して、「privileged-mode：false」を「privileged-mode：true」に変更します。 


| Kubernetes で、 Telegraf ReplicaSet ポッドから次のエラーが報告されています。 [ プラグインの inputs.prometheus] エラー： Could not load keypair /etc/Kubernetes /pki/ etcd/server.crt ： /etc/Kubernetes /pki/ etcd/server.key ： open /etc/Kubernetes /pki/ etcd/server.key ：特定のディレクトリまたは crt ファイルをロードできませんでした | Telegraf ReplicaSet ポッドは、マスターまたは etcd 用に指定されたノード上で実行することを目的としています。これらのノードのいずれかで ReplicaSet ポッドが実行されていない場合は、これらのエラーが発生します。マスター / etcd ノードに汚染があるかどうかを確認します。その場合は、 Telegraf ReplicaSet 、テレグラム af-RS に必要な忍容を追加します。たとえば、 ReplicaSet...kubectl を編集して RS テレグラムを編集し、仕様に適切な公差を追加します。次に、 ReplicaSet ポッドを再起動します。 


| PSP/PSA環境があります。これはモニタリングオペレータに影響しますか？ | ポッドセキュリティポリシー（PSP）またはポッドセキュリティアドミッション（PSA）を適用してKubernetesクラスタを実行している場合は、最新のNetApp Kubernetes Monitoring Operatorにアップグレードする必要があります。PSP/PSAをサポートして現在のNKMOにアップグレードするには、次の手順に従います。1. <<uninstalling,をアンインストールします>> 前の監視オペレータ：kubectl delete agent agent-monitoring netapp -n netapp -monitoring kubectl delete ns NetApp-monitoring kubectl delete CRD agents.monitoring.netapp.com kubectl delete clusterrole agent-manager-role agent-proxy-metrics -reader kubectl delete clusterrolebinding agent-manager-rolebinding agent-proxy -proxy -proxy -proxy -proxy -proxy -proxy -proxy -binding中のクラスタ役割を持つadminエージェントの役割を持つ役割を持つ役割を果たす役割を担う役割は、それぞれ果たす役割を担う。 <<installing-the-netapp-kubernetes-monitoring-operator,をインストールします>> モニタリングオペレータの最新バージョン。 


| NKMOを導入する際に問題が発生し、PSP/PSAを使用しました。 | 1.次のコマンドを使用して、エージェントを編集します。kubectl -n <name-space> edit agent 2.「security-policy enabled」を「false」に設定します。これにより、ポッドセキュリティポリシーとポッドセキュリティアドミッションが無効になり、NKMOが展開できるようになります。次のコマンドを使用して確認します。kubectl get psp（should show Pod Security Policy removed）kubectl get all -n <namespace>| grep -i psp（should show that nothing is found） 


| 「ImagePullBackoff」エラーが発生しました | このエラーは、カスタムまたはプライベートのDockerリポジトリがあり、NetApp Kubernetes Monitoring Operatorで正しく認識されるように設定していない場合に表示されることがあります。 <<using-a-custom-or-private-docker-repository,詳細はこちら>> カスタム/プライベートリポジトリの設定について 
|===
追加情報はから入手できます link:concept_requesting_support.html["サポート"] ページまたはを参照してください link:https://docs.netapp.com/us-en/cloudinsights/CloudInsightsDataCollectorSupportMatrix.pdf["Data Collector サポートマトリックス"]。
